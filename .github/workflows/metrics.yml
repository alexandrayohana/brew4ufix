name: Code Metrics with CK

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  workflow_dispatch:  # Manual trigger

jobs:
  analyze-metrics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for better analysis
    
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Set up Maven
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: 'maven'
    
    - name: Clone and Build CK Tool
      run: |
        echo "Cloning CK repository..."
        git clone https://github.com/mauricioaniche/ck.git ck-tool
        cd ck-tool
        echo "Building CK with Maven..."
        mvn clean compile assembly:single -DskipTests
        cd ..
        echo "CK tool built successfully"
    
    - name: Run CK Metrics Analysis
      run: |
        echo "Running CK metrics analysis..."
        mkdir -p metrics-output
        
        # Find the built jar file
        CK_JAR=$(find ck-tool/target -name "*-jar-with-dependencies.jar" | head -n 1)
        echo "Using CK jar: $CK_JAR"
        
        # Run CK analysis
        # Parameters: <project dir> <use jars> <max files at time> <variable and field metrics>
        java -jar "$CK_JAR" . false 0 false
        
        echo "Analysis completed"
    
    - name: Display Metrics Summary
      run: |
        echo "=== CK Metrics Results ==="
        if [ -f "class.csv" ]; then
          echo "Class metrics:"
          head -n 5 class.csv
          echo "..."
          echo "Total classes analyzed: $(tail -n +2 class.csv | wc -l)"
        fi
        
        if [ -f "method.csv" ]; then
          echo ""
          echo "Method metrics:"
          head -n 5 method.csv
          echo "..."
          echo "Total methods analyzed: $(tail -n +2 method.csv | wc -l)"
        fi
    
    - name: Upload Metrics Results
      uses: actions/upload-artifact@v4
      with:
        name: ck-metrics-results
        path: |
          class.csv
          method.csv
          variable.csv
          field.csv
        retention-days: 30
    
    - name: Generate Metrics Report
      run: |
        echo "# Code Metrics Report" > metrics-report.md
        echo "" >> metrics-report.md
        echo "Generated on: $(date)" >> metrics-report.md
        echo "" >> metrics-report.md
        
        if [ -f "class.csv" ]; then
          echo "## Summary" >> metrics-report.md
          echo "- **Total Classes:** $(tail -n +2 class.csv | wc -l)" >> metrics-report.md
          
          if [ -f "method.csv" ]; then
            echo "- **Total Methods:** $(tail -n +2 method.csv | wc -l)" >> metrics-report.md
          fi
          
          echo "" >> metrics-report.md
          echo "## Top 10 Most Complex Classes (by CBO)" >> metrics-report.md
          echo "" >> metrics-report.md
          echo "\`\`\`" >> metrics-report.md
          head -n 1 class.csv >> metrics-report.md
          tail -n +2 class.csv | sort -t',' -k5 -rn | head -n 10 >> metrics-report.md
          echo "\`\`\`" >> metrics-report.md
        fi
        
        cat metrics-report.md
    
    - name: Upload Metrics Report
      uses: actions/upload-artifact@v4
      with:
        name: metrics-report
        path: metrics-report.md
        retention-days: 30
    
    - name: Comment PR with Metrics (Optional)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          if (fs.existsSync('metrics-report.md')) {
            const report = fs.readFileSync('metrics-report.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });
          }
